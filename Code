import RPi.GPIO as GPIO 
import time
import http.client, urllib.parse

# ---------- GPIO SETUP ----------
PIR_PIN = 23  # GPIO 23 (BCM)

GPIO.setmode(GPIO.BCM)
GPIO.setup(PIR_PIN, GPIO.IN)

# ---------- PUSHOVER ----------
PUSH_TOKEN = "Insert_Own_TOKEN" # Je nach device anders!
PUSH_USER  = "Insert_Own_USER_ID" 

# ---------- CALLBACK ----------
last_trigger_time = 0
COOLDOWN = 5  # Sekunden (Anti-Spam)

def send_push():
    conn = http.client.HTTPSConnection("api.pushover.net", 443)
    conn.request(
        "POST",
        "/1/messages.json",
        urllib.parse.urlencode({
            "token": PUSH_TOKEN,
            "user": PUSH_USER,
            "message": "Motion detected! Bewegung erkannt!", # Augabe auf dem Device als Push-Mitteilung
        }),
        {"Content-type": "application/x-www-form-urlencoded"}
    )
    conn.getresponse()
    conn.close()

def motion_detected(channel):
    global last_trigger_time
    current_time = time.time()

    if current_time - last_trigger_time > COOLDOWN:
        print("Motion detected!") # Ausgabe auf Konsole sobald eine Bewegung erkannt wurde.
        send_push()
        last_trigger_time = current_time

# ---------- EVENT ----------
GPIO.add_event_detect(
    PIR_PIN,
    GPIO.RISING,
    callback=motion_detected,
    bouncetime=300
)

print("PIR Sensor aktiv - warte auf Bewegung...") # Ausgabe auf Konsole beim Starten des Skripts

try:
    while True:
        time.sleep(1)

except KeyboardInterrupt:
    print("Programm beendet")
    GPIO.cleanup()
